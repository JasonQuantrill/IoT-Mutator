rule "Irrigation - protection timer off, close all valves"
when
	Item IrrigationTimerMax changed to OFF
then
	
	logWarn(logName, "Irrigation protection timer expired - close all valves")

	
	GroupIrrigationValves.members.forEach [valve | 
		logDebug(logName, "Closing valve: " + valve.name)
		valve.sendCommand(OFF)
	]
end

rule "Irrigation - valve updated, turn on the timer"
when
	Item GroupIrrigationValves changed 
then
	
	
	
	GroupIrrigationValves.members.forEach [valve | 
		logDebug(logName, "Irrigation valve: " + valve.name + " " + valve.state)
	]

	
	if (GroupIrrigationValves.state == ON) {
		if (IrrigationTimerMax.state == OFF) {
			
			logDebug(logName, "Irrigation valve open, starting protection timer")
			IrrigationTimerMax.sendCommand(ON)
		}
		else {
			
			logDebug(logName, "Irrigation valve open, timer already started, nothing to do")
		}
	}
	else {
		logDebug(logName, "All irrigation valves closed, stopping protection timer")
		IrrigationTimerMax.postUpdate(OFF)
	}
	triggeringItem.postUpdate(triggeringItem.state)
end